---
title: "Programa Nacional de Prevención y Control de las ETVs de México | CENAPRECE"
output: 
  flexdashboard::flex_dashboard:
      theme: united
      social: ["twitter", "facebook", "menu", "github"]
output_dir: libs      
---

```{r setup, echo=FALSE}

# Step 2. load datasets ####
if(as.vector(Sys.info()["sysname"]) == "Darwin"){
  
  # 3.1 define the path
  
  # path sinave
  path_sinave <- "/Users/fdzul/Library/CloudStorage/OneDrive-Personal/datasets/DGE/arbo/"
  
  # 3.1 arbovirosis dataset
  x <- boldenr::read_dataset_bol(path = path_sinave,
                                 dataset = "sinave")
  
} else if(as.vector(Sys.info()["sysname"]) == "Windows"){
  
} else if(as.vector(Sys.info()["sysname"]) == "Linux"){
    
}



# Step 3. load the functions ####
if(as.vector(Sys.info()["sysname"]) == "Darwin"){
    # .1 dengue dataset
    source("~/Dropbox/r_developments/r_new_functions/3.Functions/heatmap_confirmados.R")
    source("~/Dropbox/r_developments/r_new_functions/3.Functions/heatmap_hospitalizados.R")
    source("~/Dropbox/r_developments/r_new_functions/3.Functions/static_bump_map.R")
    
    
  
    
} else if(as.vector(Sys.info()["sysname"]) == "Windows"){

    # load the heatmap confirmados y hospitalizados function
    source('C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_dashboard/3.Functions/heatmap_confirmados.R')
    source("C:/Users/HOME/Dropbox/r_developments/r_dashboards/github_pages/test_denv_dash_yuc/functions/heatmap_hospitalizados.R")
    source("C:/Users/HOME/Dropbox/r_developments/r_new_functions/3.Functions/static_bump_map.R")
    
  
} else if(as.vector(Sys.info()["sysname"]) == "Linux"){
    
}



```


# **Programa de Prevención y Control de las Arbovirosis**

## Column {.tabset}

### [**Mapas de Riesgo de Transmisión**]{style="color:#990000"}

```{r dengue_risk_map}
# Step 1. load the AGEE ####
mex <- rgeomex::AGEE_inegi19_mx

# Step 3. make the tible link ####
link <- tibble::tibble(CVE_ENT = c("31", "30", "23","20", "04", "17", "14", "16"),
                       link = c("https://beautiful-haupia-810701.netlify.app/",
                               "https://zippy-bunny-bdd8c7.netlify.app/",
                               "https://helpful-pegasus-ba8bb9.netlify.app/",
                               "https://merry-figolla-08f5bf.netlify.app/",
                               "https://phenomenal-hotteok-02e188.netlify.app/",
                               "https://glistening-griffin-b8023f.netlify.app/",
                               "https://heartfelt-fudge-936865.netlify.app",
                               "https://fabulous-mermaid-31ea6a.netlify.app"))

# Step 3. left joint ####
mex_link <- dplyr::left_join(x = link,
                             y = mex,
                             by = "CVE_ENT") |>
    dplyr::mutate(Estado = paste0(": <a href=", 
                                  link,">", 
                                  NOMGEO, "</a>")) |>
    as.data.frame() |>
    sf::st_set_geometry(value = "geometry") 

mex_link |>
    mapview::mapview(popup = "Estado",
                     legend = FALSE)
```

> Con un click se proporcionan los mapas de riesgo de transmisión de dengue de los estados. Los estados en color azul tiene definido su riesdo de transmisión y el resto está en construción.

### [**Panorama Epidemiológico Dengue**]{style="color:#990000"}

<html>
<head>
<style>
</style>
</head>
<body>
<div >
  <h2></h2>
  <p></p>

<div style = "display: grid; width: 1px; grid-template-columns: 700px 700px; align-items: start; justify-content: space-between;">
#### **<span style="color:blue"> Treemap de casos confirmados </span>**
```{r treemap_national, out.width="100%", out.height="100%"}
x  |>
    dplyr::filter(ANO == 2023)  |>
    dplyr::filter(!DES_EDO_RES %in% c("OTROS PAISES", 
                                      "OTROS PAISES DE LATINOAMERICA",
                                      "ESTADOS UNIDOS DE NORTEAMERICA"))  |>
    dplyr::filter(DES_DIAG_FINAL %in% 
                      c("DENGUE CON SIGNOS DE ALARMA", "DENGUE NO GRAVE", 
                        "DENGUE GRAVE"))  |>
    dplyr::group_by(DES_EDO_RES,DES_DIAG_FINAL)  |>
    dplyr::summarise(value = dplyr::n(), 
                     .groups = "drop")  |>
    dplyr::mutate(DES_EDO_RES = stringr::str_to_title(DES_EDO_RES),
                  DES_DIAG_FINAL = stringr::str_to_title(DES_DIAG_FINAL))  |>
    dplyr::mutate(DES_DIAG_FINAL = factor(DES_DIAG_FINAL,
                                          levels = c("Dengue Con Signos De Alarma",
                                                     "Dengue Grave",
                                                     "Dengue No Grave"),
                                          labels = c("DSA", "DG", "DNG")))  |>
    ggplot2::ggplot(ggplot2::aes(area = value, 
                                 fill = DES_EDO_RES,
                                 subgroup = DES_EDO_RES,
                                 label = DES_DIAG_FINAL)) +
    treemapify::geom_treemap() +
    treemapify::geom_treemap_text(fontface = "italic", 
                                  colour = "black", 
                                  place = "bottom",
                                  #alpha = 0.5,
                                  grow = F) +
    treemapify::geom_treemap_subgroup_text(place = "middle", 
                                           colour = "White", 
                                           #alpha = 0.8, 
                                           grow = T)+
    ggplot2::theme(legend.position = "none") +
    ggplot2::scale_fill_viridis_d()
```

<div>
#### **<span style="color:blue"> Casos confirmados y serotipos </span>**
```{r casos_serotipos,out.width="100%", out.height="100%"}
library(magrittr)
boldenr::plot_state_serotype(dataset = x, 
                                  year = 2023, 
                                  x_serotype  = 0.5, 
                                  y_serotype = 0.17, 
                                  scale_serotype = 1.7)
```
</div>

</div>
#### **<span style="color:blue"> Casos confirmados por semana </span>**
```{r casos_semana}
heatmap_confirmados(dataset = x, 
                    year = 2023, 
                    size_text = 3, 
                    EDO = TRUE)
```


#### **<span style="color:blue"> Casos Confirmados </span>**
```{r bumpmap_national_2023, out.width="100%", out.height="100%"}
library(dplyr)
static_bump_map(dataset = x,
                year = "2023",
                state = TRUE,
                size_text_value = 2,
                size_text = 2,
                country_text_x = 0.5,
                country_text_y = 0.8,
                line_size = 1.5,
                pal_vir = "viridis")
```
</div>

</body>
</html>


### [**Distribución del Dengue**]{style="color:#990000"}

```{r distribucion_dengue}
if(as.vector(Sys.info()["sysname"]) == "Darwin"){
    load("~/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")
    
} else if(as.vector(Sys.info()["sysname"]) == "Windows"){
    load("D:/OneDrive/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")

} else if(as.vector(Sys.info()["sysname"]) == "Linux"){
    
}

z <- z |>
    sf::st_as_sf(coords = c("long", "lat"),
                 crs = 4326) |>
    dplyr::mutate(ESTATUS_CASO = ifelse(ESTATUS_CASO == 1,
                                   "Probable",
                                   "Confirmado"))

confirmados <- z |>
    dplyr::filter(ESTATUS_CASO == "Confirmado")
probables <- z |>
    dplyr::filter(ESTATUS_CASO == "Probable")

serotype_1 <- z |>
    dplyr::filter(ESTATUS_CASO == "Confirmado") |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 1)
serotype_2 <- z |>
    dplyr::filter(ESTATUS_CASO == "Confirmado") |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 2)
serotype_3 <- z |>
    dplyr::filter(ESTATUS_CASO == "Confirmado") |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 3)
serotype_4 <- z |>
    dplyr::filter(ESTATUS_CASO == "Confirmado") |>
    dplyr::filter(DENGUE_SER_TRIPLEX == 4)

##############
mapview::mapview(probables,
                 col.regions = "#898F9C",
                 color = "white",
                 layer.name = "Probables") +
    mapview::mapview(confirmados,
                     col.regions = "#4267B2",
                     color = "white",
                     layer.name = "Positivos") +
    mapview::mapview(serotype_1,
                     col.regions = "#36C5F0",
                     color = "white",
                     layer.name = "DENV-1") +
    mapview::mapview(serotype_2,
                     col.regions = "#2EB67D",
                     color = "white",
                     layer.name = "DENV-2") +
    mapview::mapview(serotype_3,
                     col.regions = "#E01E5A",
                     color = "white",
                     layer.name = "DENV-3") +
    mapview::mapview(serotype_4,
                     col.regions = "#FC642D",#"#ECB22E",
                     color = "white",
                     layer.name = "DENV-4")
```

### [**Cadenas de Transmisión (Confirmados)**]{style="color:#990000"}

```{r cadenas_transmision_confirmado}
library(magrittr)
if(as.vector(Sys.info()["sysname"]) == "Darwin"){
    load("~/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")
    
} else if(as.vector(Sys.info()["sysname"]) == "Windows"){
    load("D:/OneDrive/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")

} else if(as.vector(Sys.info()["sysname"]) == "Linux"){
    
}

denhotspots::transmission_chains_map(geocoded_dataset = z,
                                     cve_edo = "31",
                                     locality = NULL,
                                     dengue_cases = "Confirmado")
```

### [**Cadenas de Transmisión (Probables)**]{style="color:#990000"}

```{r cadenas_transmision_probable}
library(magrittr)
if(as.vector(Sys.info()["sysname"]) == "Darwin"){
    load("~/Library/CloudStorage/OneDrive-Personal/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")
    
} else if(as.vector(Sys.info()["sysname"]) == "Windows"){
    load("D:/OneDrive/proyects/geocoding_mex/2023/9.geocoded_dataset/dengue_mx_2023.RData")

} else if(as.vector(Sys.info()["sysname"]) == "Linux"){
    
}

denhotspots::transmission_chains_map(geocoded_dataset = z,
                                     cve_edo = "31",
                                     locality = NULL,
                                     dengue_cases = "Probable")
```



